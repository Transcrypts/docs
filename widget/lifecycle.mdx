---
title: "Widget Lifecycle"
description: "Step-by-step flow from verify() call to result"
---

The Transcrypts verification widget is an iframe-based UI that the SDK injects into your page. When your application calls `verify()`, the SDK creates a full-viewport overlay containing an iframe that loads the Transcrypts widget application. The widget guides users through employment verification, communicating status and results back to your application via the browser `postMessage` API.

The widget is a self-contained React application. Your application never interacts with the widget DOM directly -- all communication happens through structured message events.

## Verification Flow

```
verify() called
  |
  v
SDK creates session token (base64-encoded JSON)
  |
  v
SDK creates iframe overlay, appends to document.body
  |
  v
Iframe loads: {widgetUrl}/verify?token={base64token}
  |
  v
Widget parses token, validates apiKey and ssn
  |
  v
Widget sends "ready" event to parent
  |
  v
Widget fetches user data (loading spinner shown)
  |
  v
Widget sends "loaded" event with masked SSN
  |
  v
User reviews profile and work experience list
  |
  v
User clicks VERIFY on a job --> verification options modal
  |
  v
User selects verification method --> job marked as verified
  |
  v
User clicks Continue
  |
  v
Widget sends "verification_complete" event with results
  |
  v
SDK validates message origin, cleans up iframe, resolves promise
```

## Step-by-Step Detail

<Steps>
  <Step title="Token Creation">
    The SDK encodes `{ apiKey, ssn, user, timestamp }` as a base64 string via `btoa(JSON.stringify(payload))`.
  </Step>

  <Step title="Iframe Injection">
    The SDK creates a container `<div>` (the backdrop overlay) and an `<iframe>` element. Both are appended to `document.body`. Body scroll is locked by setting `overflow: hidden`.
  </Step>

  <Step title="Widget Initialization">
    The widget (a separate React app at the iframe URL) reads the `token` query parameter, decodes it with `atob`, and parses the JSON. It validates that `apiKey` and `ssn` are present.
  </Step>

  <Step title="Ready Signal">
    Once parsed, the widget posts `{ type: 'ready', payload: {} }` to `window.parent`.
  </Step>

  <Step title="Data Loading">
    The widget fetches user data and employment records. During this phase a loading spinner is displayed. On completion, it posts `{ type: 'loaded', payload: { ssn: '***-**-1234' } }` with the masked SSN.
  </Step>

  <Step title="Interactive Review">
    The widget renders the user profile, work experience cards, and a progress bar. The user can click VERIFY on any job to open the verification options modal.
  </Step>

  <Step title="Verification">
    The user selects a verification method. The job is marked as verified in the widget UI and the progress bar updates.
  </Step>

  <Step title="Completion">
    The user clicks Continue. The widget posts `{ type: 'verification_complete', payload: { ... } }` with the full result. The SDK receives the message, validates the origin, destroys the iframe overlay (with fade-out animation), restores body scroll, and resolves the `verify()` promise.
  </Step>
</Steps>

## postMessage Protocol

Communication between the SDK (parent window) and the widget (iframe) uses the browser `window.postMessage` API.

### Direction: Widget to Parent

The widget sends messages to the parent via:

```typescript
window.parent.postMessage({ type, payload }, '*');
```

Every message is a plain object with `type` (string) and `payload` (object) fields.

### Direction: Parent to Self (Close Trigger)

When the user clicks the backdrop overlay (outside the iframe), the SDK container's click handler sends a close message to its own window:

```typescript
window.postMessage({ type: 'close' }, '*');
```

The SDK's message listener picks this up and triggers cleanup. This allows the close behavior to flow through the same event pipeline as widget-originated messages.

### Message Format

```typescript
{
  type: string;              // Event type identifier
  payload: object;           // Event-specific data
}
```

### Origin Validation

The SDK validates every incoming `postMessage` against the widget origin:

```typescript
private isValidOrigin(origin: string): boolean {
  try {
    const widgetOrigin = new URL(this.widgetUrl).origin;
    return origin === widgetOrigin;
  } catch {
    return false;
  }
}
```

Only messages whose `event.origin` matches `new URL(widgetUrl).origin` are processed. All other messages are silently discarded.

<Note>
The backdrop-click close message is sent via `window.postMessage` to the same window, so its origin will match the parent page's origin, not the widget origin. This message bypasses origin validation because it originates from the SDK's own event handler within the `handleMessage` callback flow.
</Note>
